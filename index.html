<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Splash Pro X</title>
    <style>
        /* --- Global Styles & Theming --- */
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            --text-primary: #1c1e21;
            --text-secondary: #606770;
            --primary-color: #1877f2;
            --primary-hover: #166fe5;
            --border-color: #ccd0d5;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.2);
            --selection-color: #1877f2;
            --delete-color: #fa383e;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Layout --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        header {
            background-color: var(--panel-bg);
            box-shadow: 0 2px 4px var(--shadow-light);
            padding: 0.75rem 1.5rem;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            gap: 1rem;
            overflow: hidden;
        }

        .workspace {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            overflow: hidden;
        }

        .panel {
            background-color: var(--panel-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow-light);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-secondary);
        }
        .panel-content {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-color);
        }

        .presets-gallery {
            flex-shrink: 0;
            background-color: var(--panel-bg);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        /* --- Controls --- */
        .controls-area {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            padding: 0.5rem 0;
        }
        .control-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        button:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        button.primary {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        button.primary:hover {
            background-color: var(--primary-hover);
        }
        button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        button:disabled {
            background-color: var(--bg-color);
            border-color: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* --- Canvas & Editor --- */
        .canvas-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            cursor: grab;
        }
        .canvas-wrapper.panning { cursor: grabbing; }
        .canvas-wrapper.crosshair { cursor: crosshair; }

        canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: 0 0;
            background-color: #fff;
        }
        
        #editor-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .selection-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #fff;
            border: 2px solid var(--selection-color);
            border-radius: 50%;
            pointer-events: all;
        }
        .selection-handle:hover {
            transform: scale(1.2);
        }

        .placeholder {
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        /* --- Presets --- */
        .presets-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-top: 0.5rem;
        }
        .preset-item {
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .preset-item:hover {
            transform: translateY(-4px);
        }
        .preset-item canvas {
            width: 100%;
            height: auto;
            aspect-ratio: 16/9;
            background-color: var(--bg-color);
            border-radius: 8px;
            border: 3px solid transparent;
            box-shadow: 0 1px 3px var(--shadow-light);
            transition: border-color 0.2s ease;
        }
        .preset-item.active canvas {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }
        .preset-item code {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            font-weight: 500;
        }

        /* --- Utility & Hidden --- */
        .hidden { display: none !important; }
        .spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h1>Color Splash Pro X</h1>
            <div class="controls-area">
                <div class="control-group">
                    <button id="uploadBtn" class="primary" title="Upload a new image">üì§ Upload</button>
                    <button id="saveBtn" title="Save your work as a JSON file" disabled>üíæ Save</button>
                    <button id="loadBtn" title="Load work from a JSON file">üìÇ Load</button>
                </div>
                <div class="control-group">
                    <button id="undoBtn" title="Undo last action (Ctrl+Z)" disabled>‚Ü©Ô∏è Undo</button>
                    <button id="redoBtn" title="Redo last action (Ctrl+Y)" disabled>‚Ü™Ô∏è Redo</button>
                </div>
                <div class="control-group">
                    <button id="modeLassoBtn" class="active" title="Smart Select Tool (S)">‚ú® Smart Select</button>
                    <button id="modeBoxBtn" title="Box Select Tool (B)">üî≤ Box Select</button>
                </div>
                 <div class="control-group">
                    <button id="deleteSelectionBtn" title="Delete selected object (Delete/Backspace)" disabled>üóëÔ∏è Delete</button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="workspace">
                <div class="panel">
                    <div class="panel-header">EDITOR (Original Image) - Hold Spacebar to Pan, Scroll to Zoom</div>
                    <div class="panel-content">
                        <div id="editor-wrapper" class="canvas-wrapper">
                            <canvas id="editor-canvas"></canvas>
                            <div id="editor-overlay"></div>
                            <div id="editor-placeholder" class="placeholder">Upload an image to begin</div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header">LIVE PREVIEW</div>
                    <div class="panel-content">
                        <canvas id="preview-canvas"></canvas>
                        <div id="preview-placeholder" class="placeholder">Your result will appear here</div>
                    </div>
                </div>
            </div>

            <div class="presets-gallery">
                <div id="presets-container" class="presets-container">
                    <!-- Presets will be generated here -->
                </div>
            </div>
        </main>
    </div>

    <input type="file" id="fileInput" accept="image/*" class="hidden">
    <input type="file" id="loadInput" accept=".json,.txt" class="hidden">

    <script>
    (function() {
        'use strict';

        // --- DOM Cache ---
        const dom = {
            uploadBtn: document.getElementById('uploadBtn'),
            saveBtn: document.getElementById('saveBtn'),
            loadBtn: document.getElementById('loadBtn'),
            undoBtn: document.getElementById('undoBtn'),
            redoBtn: document.getElementById('redoBtn'),
            modeLassoBtn: document.getElementById('modeLassoBtn'),
            modeBoxBtn: document.getElementById('modeBoxBtn'),
            deleteSelectionBtn: document.getElementById('deleteSelectionBtn'),
            editorWrapper: document.getElementById('editor-wrapper'),
            editorCanvas: document.getElementById('editor-canvas'),
            editorOverlay: document.getElementById('editor-overlay'),
            editorPlaceholder: document.getElementById('editor-placeholder'),
            previewCanvas: document.getElementById('preview-canvas'),
            previewPlaceholder: document.getElementById('preview-placeholder'),
            presetsContainer: document.getElementById('presets-container'),
            fileInput: document.getElementById('fileInput'),
            loadInput: document.getElementById('loadInput'),
        };

        // --- State Management ---
        let state = {
            originalImage: null,
            selections: [],
            activeSelectionIndex: -1,
            currentMode: 'lasso',
            history: [],
            historyIndex: -1,
            transform: { x: 0, y: 0, scale: 1 },
            isPanning: false,
            activePresetIndex: 0,
        };

        const PRESETS = [
            { name: 'Classic', effect: 'grayscale', aggressiveness: 25 },
            { name: 'High Contrast', effect: 'contrast', aggressiveness: 40 },
            { name: 'Sepia Tone', effect: 'sepia', aggressiveness: 30 },
            { name: 'Vivid', effect: 'grayscale', aggressiveness: 70 },
            { name: 'Inverted', effect: 'invert', aggressiveness: 50 },
        ];

        // --- Utility Functions ---
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // --- Core Rendering Module ---
        const renderer = {
            editorCtx: dom.editorCanvas.getContext('2d'),
            previewCtx: dom.previewCanvas.getContext('2d'),
            maskCanvas: document.createElement('canvas'),
            
            init() {
                this.maskCtx = this.maskCanvas.getContext('2d');
            },

            renderAll() {
                if (!state.originalImage) return;
                this.renderEditor();
                this.renderPreview();
            },

            renderEditor() {
                const { originalImage, transform } = state;
                if (!originalImage) return;

                const canvas = dom.editorCanvas;
                const ctx = this.editorCtx;

                canvas.width = dom.editorWrapper.clientWidth;
                canvas.height = dom.editorWrapper.clientHeight;

                ctx.save();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.translate(transform.x, transform.y);
                ctx.scale(transform.scale, transform.scale);
                ctx.drawImage(originalImage, 0, 0);
                ctx.restore();

                this.renderSelectionOverlays();
            },

            renderPreview: debounce(function() {
                const { originalImage, selections, activePresetIndex } = state;
                if (!originalImage) return;

                const preset = PRESETS[activePresetIndex];
                const canvas = dom.previewCanvas;
                const ctx = this.previewCtx;
                const maskCanvas = this.maskCanvas;
                const maskCtx = this.maskCtx;

                // Fit image to preview panel
                const container = dom.previewCanvas.parentElement;
                const aspect = originalImage.width / originalImage.height;
                let w = container.clientWidth;
                let h = w / aspect;
                if (h > container.clientHeight) {
                    h = container.clientHeight;
                    w = h * aspect;
                }
                canvas.width = w;
                canvas.height = h;
                maskCanvas.width = originalImage.width;
                maskCanvas.height = originalImage.height;

                // 1. Create the selection mask
                maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
                maskCtx.fillStyle = 'white';
                selections.forEach(sel => {
                    if (sel.type === 'box') {
                        maskCtx.fillRect(sel.x, sel.y, sel.width, sel.height);
                    } else if (sel.type === 'lasso') {
                        const radius = (preset.aggressiveness / 100) * (Math.min(originalImage.width, originalImage.height) / 4);
                        maskCtx.beginPath();
                        maskCtx.arc(sel.x, sel.y, radius, 0, Math.PI * 2);
                        maskCtx.fill();
                    }
                });

                // 2. Draw the base effect (e.g., grayscale)
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save();
                this.applyFilter(ctx, preset.effect, canvas.width, canvas.height);
                ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
                ctx.restore();

                // 3. Use the mask to punch color through
                ctx.save();
                ctx.globalCompositeOperation = 'destination-in';
                ctx.drawImage(maskCanvas, 0, 0, canvas.width, canvas.height);
                ctx.globalCompositeOperation = 'source-over'; // Reset
                ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
                ctx.restore();

            }, 100),

            renderSelectionOverlays() {
                dom.editorOverlay.innerHTML = ''; // Clear old overlays
                const { selections, activeSelectionIndex, transform } = state;

                selections.forEach((sel, index) => {
                    const el = document.createElement('div');
                    el.style.position = 'absolute';
                    el.style.pointerEvents = 'none';
                    el.style.border = `2px solid ${index === activeSelectionIndex ? 'var(--selection-color)' : 'rgba(255,255,255,0.7)'}`;
                    
                    if (index === activeSelectionIndex) {
                        el.style.boxShadow = `0 0 0 2px rgba(0,0,0,0.5), 0 0 15px ${'var(--selection-color)'}`;
                    }

                    if (sel.type === 'box') {
                        el.style.left = `${sel.x * transform.scale + transform.x}px`;
                        el.style.top = `${sel.y * transform.scale + transform.y}px`;
                        el.style.width = `${sel.width * transform.scale}px`;
                        el.style.height = `${sel.height * transform.scale}px`;
                    } else if (sel.type === 'lasso') {
                        const radius = (PRESETS[state.activePresetIndex].aggressiveness / 100) * (Math.min(state.originalImage.width, state.originalImage.height) / 4);
                        const scaledRadius = radius * transform.scale;
                        el.style.left = `${sel.x * transform.scale + transform.x - scaledRadius}px`;
                        el.style.top = `${sel.y * transform.scale + transform.y - scaledRadius}px`;
                        el.style.width = `${scaledRadius * 2}px`;
                        el.style.height = `${scaledRadius * 2}px`;
                        el.style.borderRadius = '50%';
                    }
                    dom.editorOverlay.appendChild(el);
                });
            },

            renderPresets() {
                dom.presetsContainer.innerHTML = '';
                PRESETS.forEach((preset, index) => {
                    const item = document.createElement('div');
                    item.className = 'preset-item';
                    if (index === state.activePresetIndex) {
                        item.classList.add('active');
                    }
                    item.innerHTML = `<canvas></canvas><code>${preset.name} (Agg: ${preset.aggressiveness})</code>`;
                    
                    const canvas = item.querySelector('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Render a quick version of the effect
                    if (state.originalImage) {
                        const aspect = state.originalImage.width / state.originalImage.height;
                        canvas.width = 200;
                        canvas.height = 200 / aspect;
                        ctx.save();
                        this.applyFilter(ctx, preset.effect, canvas.width, canvas.height);
                        ctx.drawImage(state.originalImage, 0, 0, canvas.width, canvas.height);
                        ctx.restore();
                    }

                    item.addEventListener('click', () => {
                        state.activePresetIndex = index;
                        this.renderPresets();
                        this.renderPreview();
                    });
                    dom.presetsContainer.appendChild(item);
                });
            },

            applyFilter(ctx, effect, w, h) {
                switch (effect) {
                    case 'grayscale': ctx.filter = 'grayscale(100%)'; break;
                    case 'contrast': ctx.filter = 'grayscale(100%) contrast(1.5)'; break;
                    case 'sepia': ctx.filter = 'sepia(100%)'; break;
                    case 'invert': ctx.filter = 'invert(100%)'; break;
                    default: ctx.filter = 'none';
                }
            }
        };

        // --- Interaction Handler ---
        const interactionHandler = {
            startPan: { x: 0, y: 0 },
            startTransform: { x: 0, y: 0 },
            isDrawing: false,
            startDrawPos: { x: 0, y: 0 },

            init() {
                const wrapper = dom.editorWrapper;
                wrapper.addEventListener('mousedown', this.onMouseDown.bind(this));
                wrapper.addEventListener('mousemove', this.onMouseMove.bind(this));
                wrapper.addEventListener('mouseup', this.onMouseUp.bind(this));
                wrapper.addEventListener('mouseleave', this.onMouseUp.bind(this));
                wrapper.addEventListener('wheel', this.onWheel.bind(this));
                window.addEventListener('keydown', this.onKeyDown.bind(this));
                window.addEventListener('keyup', this.onKeyUp.bind(this));
            },

            getMousePos(e) {
                const rect = dom.editorCanvas.getBoundingClientRect();
                return {
                    x: (e.clientX - rect.left - state.transform.x) / state.transform.scale,
                    y: (e.clientY - rect.top - state.transform.y) / state.transform.scale
                };
            },

            onMouseDown(e) {
                if (!state.originalImage) return;
                if (state.isPanning) {
                    this.startPan = { x: e.clientX, y: e.clientY };
                    this.startTransform = { ...state.transform };
                } else {
                    this.isDrawing = true;
                    this.startDrawPos = this.getMousePos(e);
                    
                    const newSelection = {
                        type: state.currentMode,
                        x: this.startDrawPos.x,
                        y: this.startDrawPos.y,
                        width: 0,
                        height: 0,
                    };
                    state.selections.push(newSelection);
                    state.activeSelectionIndex = state.selections.length - 1;
                    stateManager.saveState();
                }
            },

            onMouseMove(e) {
                if (state.isPanning && e.buttons === 1) {
                    const dx = e.clientX - this.startPan.x;
                    const dy = e.clientY - this.startPan.y;
                    state.transform.x = this.startTransform.x + dx;
                    state.transform.y = this.startTransform.y + dy;
                    renderer.renderEditor();
                } else if (this.isDrawing) {
                    const currentPos = this.getMousePos(e);
                    const selection = state.selections[state.activeSelectionIndex];
                    selection.width = currentPos.x - this.startDrawPos.x;
                    selection.height = currentPos.y - this.startDrawPos.y;
                    
                    // Normalize for negative width/height
                    if (selection.width < 0) {
                        selection.x = currentPos.x;
                        selection.width = -selection.width;
                    }
                    if (selection.height < 0) {
                        selection.y = currentPos.y;
                        selection.height = -selection.height;
                    }
                    renderer.renderEditor();
                    renderer.renderPreview();
                }
            },

            onMouseUp(e) {
                if (this.isDrawing) {
                    this.isDrawing = false;
                    const selection = state.selections[state.activeSelectionIndex];
                    // Remove tiny selections
                    if (selection && (selection.width < 5 || selection.height < 5)) {
                        state.selections.pop();
                        state.activeSelectionIndex = -1;
                    }
                    stateManager.saveState();
                    renderer.renderAll();
                }
            },

            onWheel(e) {
                if (!state.originalImage) return;
                e.preventDefault();
                const rect = dom.editorCanvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                const zoomFactor = 1.1;
                const zoom = e.deltaY < 0 ? zoomFactor : 1 / zoomFactor;

                const newScale = state.transform.scale * zoom;
                if (newScale < 0.1 || newScale > 10) return;

                state.transform.x = mouseX - (mouseX - state.transform.x) * zoom;
                state.transform.y = mouseY - (mouseY - state.transform.y) * zoom;
                state.transform.scale = newScale;

                renderer.renderEditor();
            },

            onKeyDown(e) {
                if (e.code === 'Space' && !state.isPanning) {
                    state.isPanning = true;
                    dom.editorWrapper.classList.add('panning');
                }
                if ((e.key === 'Delete' || e.key === 'Backspace') && state.activeSelectionIndex !== -1) {
                    state.selections.splice(state.activeSelectionIndex, 1);
                    state.activeSelectionIndex = -1;
                    stateManager.saveState();
                    renderer.renderAll();
                }
                if (e.ctrlKey && e.key === 'z') { stateManager.undo(); }
                if (e.ctrlKey && e.key === 'y') { stateManager.redo(); }
                if (e.key.toLowerCase() === 's') { dom.modeLassoBtn.click(); }
                if (e.key.toLowerCase() === 'b') { dom.modeBoxBtn.click(); }
            },

            onKeyUp(e) {
                if (e.code === 'Space') {
                    state.isPanning = false;
                    dom.editorWrapper.classList.remove('panning');
                }
            }
        };

        // --- State & File Management ---
        const stateManager = {
            saveState() {
                if (state.historyIndex < state.history.length - 1) {
                    state.history = state.history.slice(0, state.historyIndex + 1);
                }
                state.history.push(JSON.stringify({
                    selections: state.selections,
                    activeSelectionIndex: state.activeSelectionIndex
                }));
                state.historyIndex++;
                this.updateUI();
            },
            undo() {
                if (state.historyIndex > 0) {
                    state.historyIndex--;
                    this.loadStateFromHistory();
                }
            },
            redo() {
                if (state.historyIndex < state.history.length - 1) {
                    state.historyIndex++;
                    this.loadStateFromHistory();
                }
            },
            loadStateFromHistory() {
                const snapshot = JSON.parse(state.history[state.historyIndex]);
                state.selections = snapshot.selections;
                state.activeSelectionIndex = snapshot.activeSelectionIndex;
                renderer.renderAll();
                this.updateUI();
            },
            updateUI() {
                dom.undoBtn.disabled = state.historyIndex <= 0;
                dom.redoBtn.disabled = state.historyIndex >= state.history.length - 1;
                dom.deleteSelectionBtn.disabled = state.activeSelectionIndex === -1;
                dom.saveBtn.disabled = !state.originalImage;
            }
        };

        // --- App Initialization ---
        function init() {
            renderer.init();
            interactionHandler.init();
            renderer.renderPresets();

            // Event Listeners
            dom.uploadBtn.addEventListener('click', () => dom.fileInput.click());
            dom.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            state.originalImage = img;
                            state.selections = [];
                            state.activeSelectionIndex = -1;
                            state.transform = { x: 0, y: 0, scale: 1 };
                            dom.editorPlaceholder.classList.add('hidden');
                            dom.previewPlaceholder.classList.add('hidden');
                            renderer.renderAll();
                            renderer.renderPresets();
                            stateManager.saveState();
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            dom.modeLassoBtn.addEventListener('click', () => {
                state.currentMode = 'lasso';
                dom.modeLassoBtn.classList.add('active');
                dom.modeBoxBtn.classList.remove('active');
            });
            dom.modeBoxBtn.addEventListener('click', () => {
                state.currentMode = 'box';
                dom.modeBoxBtn.classList.add('active');
                dom.modeLassoBtn.classList.remove('active');
            });
            
            dom.deleteSelectionBtn.addEventListener('click', () => {
                if (state.activeSelectionIndex !== -1) {
                    state.selections.splice(state.activeSelectionIndex, 1);
                    state.activeSelectionIndex = -1;
                    stateManager.saveState();
                    renderer.renderAll();
                }
            });

            window.addEventListener('resize', debounce(renderer.renderAll, 200));
            
            stateManager.updateUI();
        }

        init();
    })();
    </script>
</body>
</html>
